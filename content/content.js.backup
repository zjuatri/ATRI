// Content Script - æ³¨å…¥åˆ°ç½‘é¡µä¸­è¿è¡Œ
console.log('ZhiHuiShu content script loaded');

// æ”¯æŒçš„åŸŸååˆ—è¡¨
const SUPPORTED_DOMAINS = [
  'studywisdomh5.zhihuishu.com',
  'fusioncourseh5.zhihuishu.com'
];

// æ£€æŸ¥å½“å‰ URL æ˜¯å¦åœ¨æ”¯æŒçš„åŸŸåä¸‹
function isSupportedDomain(url = window.location.href) {
  return SUPPORTED_DOMAINS.some(domain => url.includes(domain));
}

// æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹å®šé¡µé¢ç±»å‹
function isPageType(type, url = window.location.href) {
  // type å¯ä»¥æ˜¯: 'exam', 'mastery', 'pointOfMastery', 'examAnalysis', 'study'
  if (!isSupportedDomain(url)) return false;
  
  switch(type) {
    case 'exam':
      return url.includes('/exam') && !url.includes('/pointOfMastery') && !url.includes('/examAnalysis');
    case 'mastery':
      return url.includes('/study/mastery') || url.includes('/mastery');
    case 'pointOfMastery':
      return url.includes('/pointOfMastery');
    case 'examAnalysis':
      return url.includes('/examAnalysis');
    case 'study':
      return url.includes('/study');
    default:
      return false;
  }
}

// å…¨å±€å˜é‡ï¼šå½“å‰è€ƒè¯•çš„å‚æ•°
let currentExamParams = null;

// ç›‘å¬æ¥è‡ªé¡µé¢çš„æ¶ˆæ¯ï¼ˆæ‹¦æˆªå™¨å‘é€çš„ï¼‰
window.addEventListener('message', function(event) {
  // åªæ¥å—æ¥è‡ªåŒä¸€çª—å£çš„æ¶ˆæ¯
  if (event.source !== window) return;
  
  console.log('ğŸ“¨ [content] æ”¶åˆ°é¡µé¢æ¶ˆæ¯:', event.data.type);
  
  if (event.data.type === 'EXAM_DATA_INTERCEPTED') {
    console.log('âœ… [content] Content Script æ¥æ”¶åˆ°æ‹¦æˆªçš„è€ƒè¯•æ•°æ®:', event.data.data);
    
    const examData = event.data.data;
    const questions = examData.questions || [];
    
    // ä¿å­˜å½“å‰è€ƒè¯•çš„é¢˜ç›®åˆ—è¡¨ï¼ˆæŒ‰è¯·æ±‚ä¸­çš„é¡ºåºï¼‰
    currentExamQuestions = questions;
    console.log('ğŸ“ [content] é¢˜ç›®æ•°é‡:', questions.length);
    console.log('ğŸ“‹ [content] é¢˜ç›®é¡ºåº:', currentExamQuestions.map(q => q.questionId));
    
    // é‡æ–°æå–URLå‚æ•°ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„å‚æ•°
    extractExamParams();
    
    console.log('ğŸ“‹ å½“å‰è€ƒè¯•å‚æ•°:', currentExamParams);
    
    // å¦‚æœæœ‰å½“å‰è€ƒè¯•å‚æ•°ï¼Œå¤„ç†é¢˜ç›®æ•°æ®
    if (currentExamParams && questions.length > 0) {
      console.log('ğŸš€ å‘é€é¢˜ç›®æ•°æ®åˆ° background å¤„ç†...');
      try {
        chrome.runtime.sendMessage({
          action: 'processExamData',
          fileName: currentExamParams.fileName,
          questions: questions
        }, (response) => {
          if (chrome.runtime.lastError) {
            console.error('âŒ Runtime error:', chrome.runtime.lastError.message);
            return;
          }
          
          if (response && response.success) {
            console.log('âœ… é¢˜ç›®æ•°æ®å¤„ç†å®Œæˆ:', response.result);
            
            // å¦‚æœæ­£åœ¨è‡ªåŠ¨ç­”é¢˜ï¼Œå¼€å§‹ç­”é¢˜
            if (isAutoAnswering) {
              console.log('ğŸ¤– [content] è‡ªåŠ¨ç­”é¢˜æ¨¡å¼ï¼šé¢˜åº“å·²æ›´æ–°ï¼Œå‡†å¤‡å¼€å§‹ç­”é¢˜...');
              console.log('ğŸ“Š [content] å½“å‰é¡µé¢ URL:', window.location.href);
              console.log('ğŸ“‹ [content] é¢˜ç›®æ•°é‡:', currentExamQuestions.length);
              console.log('ğŸ”¢ [content] è®¡æ•°å™¨å€¼:', answerCounter);
              
              setTimeout(() => {
                answerCounter = 1;
                console.log('ğŸš€ [content] é‡ç½®è®¡æ•°å™¨å¹¶è°ƒç”¨ autoAnswerInExamPage()');
                autoAnswerInExamPage();
              }, 1500);
            } else {
              console.log('â¸ï¸ [content] å½“å‰æœªå¼€å¯è‡ªåŠ¨ç­”é¢˜æ¨¡å¼');
            }
          } else {
            console.error('âŒ é¢˜ç›®æ•°æ®å¤„ç†å¤±è´¥:', response);
          }
        });
      } catch (err) {
        console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥ï¼ˆæ‰©å±•å¯èƒ½å·²é‡æ–°åŠ è½½ï¼‰:', err.message);
      }
    } else {
      if (!currentExamParams) {
        console.warn('âš ï¸ å½“å‰è€ƒè¯•å‚æ•°æœªåˆå§‹åŒ–ï¼Œæ— æ³•å¤„ç†é¢˜ç›®æ•°æ®');
        console.warn('âš ï¸ å½“å‰URL:', window.location.href);
      }
      if (questions.length === 0) {
        console.warn('âš ï¸ æ²¡æœ‰é¢˜ç›®æ•°æ®');
      }
    }
  }
  
  // æ‹¦æˆª getUserAnswers å“åº”ï¼ˆç­”é¢˜åˆ†æé¡µé¢ï¼‰
  if (event.data.type === 'USER_ANSWERS_INTERCEPTED') {
    console.log('âœ… æ¥æ”¶åˆ°ç­”é¢˜åˆ†ææ•°æ®:', event.data.data);
    handleUserAnswersData(event.data.data);
  }
});

// æ£€æŸ¥å½“å‰é¡µé¢åŸŸå
if (isSupportedDomain()) {
  console.log('æ™ºæ…§æ ‘é¡µé¢æ£€æµ‹æˆåŠŸ:', window.location.href);
  
  // å¦‚æœæ˜¯è€ƒè¯•é¡µé¢ï¼Œæ£€æµ‹æ‰€æœ‰ input ç»„ä»¶å¹¶æå–URLå‚æ•°
  if (isPageType('exam')) {
    console.log('æ£€æµ‹åˆ°è€ƒè¯•é¡µé¢ï¼Œå¼€å§‹æ‰«æ input ç»„ä»¶');
    
    // æå–URLå‚æ•°
    extractExamParams();
    
    // ç›‘å¬URLå˜åŒ–ï¼ˆç”¨äºå•é¡µåº”ç”¨å¯¼èˆªï¼‰
    let lastUrl = window.location.href;
    const urlObserver = new MutationObserver(() => {
      const currentUrl = window.location.href;
      if (currentUrl !== lastUrl) {
        console.log('ğŸ”„ URL å·²å˜åŒ–:', currentUrl);
        lastUrl = currentUrl;
        if (isPageType('exam', currentUrl)) {
          // é‡æ–°æå–å‚æ•°
          extractExamParams();
          
          // å¦‚æœæ­£åœ¨è‡ªåŠ¨ç­”é¢˜ï¼Œå¼€å§‹ç­”é¢˜
          if (isAutoAnswering) {
            console.log('ğŸš€ æ£€æµ‹åˆ°è¿›å…¥ exam é¡µé¢ï¼Œå‡†å¤‡ç­”é¢˜');
            console.log('ğŸ“Š å½“å‰é¢˜ç›®æ•°æ®çŠ¶æ€:', currentExamQuestions.length, 'é¢˜');
            
            setTimeout(() => {
              answerCounter = 1;
              
              // å¦‚æœå·²æœ‰é¢˜ç›®æ•°æ®ï¼Œç›´æ¥å¼€å§‹ç­”é¢˜
              if (currentExamQuestions.length > 0) {
                console.log('âœ… é¢˜ç›®æ•°æ®å·²å­˜åœ¨ï¼Œç«‹å³å¼€å§‹ç­”é¢˜');
                autoAnswerInExamPage();
              } else {
                console.log('â³ ç­‰å¾…é¢˜ç›®æ•°æ®æ‹¦æˆª...');
                // é¢˜ç›®æ•°æ®ä¼šåœ¨æ‹¦æˆªåˆ°è¯·æ±‚åè‡ªåŠ¨è§¦å‘ç­”é¢˜
              }
            }, 2000);
          }
        } else if (isPageType('pointOfMastery', currentUrl)) {
          // è·³è½¬åˆ° pointOfMastery é¡µé¢ï¼Œå¤„ç†è¿›åº¦æ£€æŸ¥
          if (isAutoAnswering) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°è·³è½¬åˆ° pointOfMastery é¡µé¢');
            setTimeout(() => {
              handlePointOfMasteryPage();
            }, 2000);
          }
        } else if (isPageType('examAnalysis', currentUrl)) {
          // è·³è½¬åˆ° examAnalysis é¡µé¢ï¼Œç­‰å¾…ç­”é¢˜åˆ†ææ•°æ®
          if (isAutoAnswering) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°è·³è½¬åˆ° examAnalysis é¡µé¢ï¼Œç­‰å¾…æ•°æ®åŠ è½½...');
            // æ•°æ®ä¼šåœ¨æ‹¦æˆªåˆ° getUserAnswers è¯·æ±‚åè‡ªåŠ¨å¤„ç†
          }
        }
      }
    });
    
    urlObserver.observe(document, { subtree: true, childList: true });
    
    // åŒæ—¶ç›‘å¬ popstate å’Œ hashchange äº‹ä»¶
    window.addEventListener('popstate', () => {
      console.log('ğŸ”„ popstate äº‹ä»¶è§¦å‘');
      const currentUrl = window.location.href;
      if (isPageType('exam', currentUrl)) {
        extractExamParams();
      } else if (isPageType('pointOfMastery', currentUrl) && isAutoAnswering) {
        setTimeout(() => {
          handlePointOfMasteryPage();
        }, 2000);
      } else if (isPageType('examAnalysis', currentUrl) && isAutoAnswering) {
        console.log('ğŸ”„ æ£€æµ‹åˆ°è·³è½¬åˆ° examAnalysis é¡µé¢ï¼ˆpopstateï¼‰');
      }
    });
    
    window.addEventListener('hashchange', () => {
      console.log('ğŸ”„ hashchange äº‹ä»¶è§¦å‘');
      const currentUrl = window.location.href;
      if (isPageType('exam', currentUrl)) {
        extractExamParams();
      } else if (isPageType('pointOfMastery', currentUrl) && isAutoAnswering) {
        setTimeout(() => {
          handlePointOfMasteryPage();
        }, 2000);
      } else if (isPageType('examAnalysis', currentUrl) && isAutoAnswering) {
        console.log('ğŸ”„ æ£€æµ‹åˆ°è·³è½¬åˆ° examAnalysis é¡µé¢ï¼ˆhashchangeï¼‰');
      }
    });
    
    setTimeout(() => {
      // åªåœ¨è€ƒè¯•é¡µé¢æ£€æµ‹ inputï¼ŒexamAnalysis é¡µé¢ä¸éœ€è¦
      if (!window.location.href.includes('examAnalysis')) {
        detectInputElements();
        // å®šæœŸæ£€æµ‹æ–°å¢çš„ input
        setInterval(detectInputElements, 3000);
      }
      
      // å¦‚æœæ­£åœ¨è‡ªåŠ¨ç­”é¢˜ï¼Œå¼€å§‹ç­”é¢˜æµç¨‹
      if (isAutoAnswering) {
        console.log('ğŸ¤– è‡ªåŠ¨ç­”é¢˜æ¨¡å¼ï¼šç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ...');
        
        // examAnalysis é¡µé¢ä¸éœ€è¦ç­‰å¾… input
        if (window.location.href.includes('examAnalysis')) {
          console.log('ğŸ“Š examAnalysis é¡µé¢ï¼Œç­‰å¾…æ•°æ®æ‹¦æˆª...');
          return;
        }
        
        // ç­‰å¾… input å…ƒç´ åŠ è½½
        const waitForInputs = () => {
          if (detectedInputs.length > 0) {
            console.log('âœ… Input å…ƒç´ å·²åŠ è½½ï¼Œå‡†å¤‡ç­”é¢˜');
            answerCounter = 1;
            // ç­‰å¾…é¢˜ç›®æ•°æ®åŠ è½½
            if (currentExamQuestions.length > 0) {
              autoAnswerInExamPage();
            } else {
              console.log('â³ ç­‰å¾…é¢˜ç›®æ•°æ®åŠ è½½...');
              // é¢˜ç›®æ•°æ®ä¼šåœ¨æ‹¦æˆªåˆ°è¯·æ±‚åè‡ªåŠ¨è§¦å‘ç­”é¢˜
            }
          } else {
            console.log('â³ æœªæ£€æµ‹åˆ° input å…ƒç´ ï¼Œ2ç§’åé‡è¯•...');
            setTimeout(() => {
              detectInputElements();
              setTimeout(waitForInputs, 500);
            }, 2000);
          }
        };
        
        setTimeout(waitForInputs, 1000);
      }
    }, 2000);
  }
}

// æå–è€ƒè¯•é¡µé¢çš„URLå‚æ•°
function extractExamParams() {
  try {
    const urlObj = new URL(window.location.href);
    const idStr = urlObj.searchParams.get('idStr');
    const recruitAndCourseId = urlObj.searchParams.get('recruitAndCourseId');
    const name = urlObj.searchParams.get('name');
    const knowledgeId = urlObj.searchParams.get('knowledgeId');
    
    if (idStr && recruitAndCourseId) {
      const fileName = `idStr=${idStr}&recruitAndCourseId=${recruitAndCourseId}.json`;
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„è€ƒè¯•
      const isNewExam = !currentExamParams || currentExamParams.fileName !== fileName;
      
      currentExamParams = {
        idStr,
        recruitAndCourseId,
        name,
        knowledgeId,
        fileName: fileName
      };
      
      console.log(isNewExam ? 'ğŸ†• æ–°è€ƒè¯•å‚æ•°:' : 'â™»ï¸ ç›¸åŒè€ƒè¯•å‚æ•°:', currentExamParams);
      
      // é€šçŸ¥ background åˆå§‹åŒ–JSONæ–‡ä»¶ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
      try {
        chrome.runtime.sendMessage({
          action: 'initExamFile',
          params: currentExamParams
        }, (response) => {
          // æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†è¿è¡Œæ—¶é”™è¯¯
          if (chrome.runtime.lastError) {
            console.error('âŒ Runtime error:', chrome.runtime.lastError.message);
            return;
          }
          
          if (response && response.success) {
            currentExamFile = response.examFile;
            console.log('âœ… è€ƒè¯•æ–‡ä»¶å·²åˆå§‹åŒ–:', currentExamFile.fileName, 'é¢˜ç›®æ•°:', currentExamFile.totalQuestions || 0);
            updateDisplayBoxContent();
          }
        });
      } catch (err) {
        console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥ï¼ˆæ‰©å±•å¯èƒ½å·²é‡æ–°åŠ è½½ï¼‰:', err.message);
      }
    } else {
      console.log('URLä¸­ç¼ºå°‘å¿…è¦å‚æ•° idStr æˆ– recruitAndCourseId');
    }
  } catch (e) {
    console.error('æå–URLå‚æ•°å¤±è´¥:', e);
  }
}

// åˆ›å»ºæ˜¾ç¤ºå‚æ•°çš„æ‚¬æµ®çª—
let displayBox = null;
let targetButton = null; // ä¿å­˜æ‰¾åˆ°çš„ç›®æ ‡æŒ‰é’®
let currentSecretStr = null; // ä¿å­˜å½“å‰çš„ secretStr
let currentDateFormate = null; // ä¿å­˜å½“å‰çš„ dateFormate
let currentTimestamp = null; // ä¿å­˜æ—¶é—´æˆ³
let detectedInputs = []; // ä¿å­˜æ£€æµ‹åˆ°çš„ input å…ƒç´ 
let currentExamFile = null; // å½“å‰è€ƒè¯•æ–‡ä»¶æ•°æ®

// è‡ªåŠ¨åˆ·é¢˜ç›¸å…³å˜é‡
let isAutoAnswering = false; // æ˜¯å¦æ­£åœ¨è‡ªåŠ¨ç­”é¢˜
let answerCounter = 1; // ç­”é¢˜è®¡æ•°å™¨
let autoAnswerInterval = null; // è‡ªåŠ¨ç­”é¢˜å®šæ—¶å™¨
let currentExamQuestions = []; // å½“å‰è€ƒè¯•çš„é¢˜ç›®åˆ—è¡¨ï¼ˆæŒ‰é¡ºåºï¼‰

// é¡µé¢åŠ è½½æ—¶ï¼Œæ¢å¤è‡ªåŠ¨ç­”é¢˜çŠ¶æ€
(async function restoreAutoAnsweringState() {
  try {
    const result = await chrome.storage.local.get(['isAutoAnswering']);
    if (result.isAutoAnswering) {
      console.log('ğŸ”„ [æ¢å¤çŠ¶æ€] æ£€æµ‹åˆ°è‡ªåŠ¨ç­”é¢˜çŠ¶æ€ï¼Œæ¢å¤ä¸­...');
      isAutoAnswering = true;
      console.log('âœ… [æ¢å¤çŠ¶æ€] isAutoAnswering å·²è®¾ç½®ä¸º true');
      console.log('ğŸ“ [æ¢å¤çŠ¶æ€] å½“å‰ URL:', window.location.href);
      
      // å¦‚æœæ˜¯è€ƒè¯•é¡µé¢ï¼Œç­‰å¾…é¢˜ç›®æ•°æ®åŠ è½½
      if (isPageType('exam')) {
        console.log('ğŸ“ [æ¢å¤çŠ¶æ€] å½“å‰åœ¨è€ƒè¯•é¡µé¢ï¼Œç­‰å¾…é¢˜ç›®æ•°æ®...');
        // autoAnswerInExamPage ä¼šåœ¨æ”¶åˆ°é¢˜ç›®æ•°æ®åè‡ªåŠ¨è°ƒç”¨
      }
    } else {
      console.log('â„¹ï¸ [æ¢å¤çŠ¶æ€] æ— éœ€æ¢å¤ï¼Œå½“å‰æœªå¯ç”¨è‡ªåŠ¨ç­”é¢˜');
    }
  } catch (e) {
    console.error('âŒ [æ¢å¤çŠ¶æ€] æ¢å¤çŠ¶æ€å¤±è´¥:', e);
  }
})();

// æ£€æµ‹é¡µé¢ä¸­çš„æ‰€æœ‰ input å…ƒç´ 
function detectInputElements() {
  const inputs = document.querySelectorAll('input');
  
  // è¿‡æ»¤æ‰çˆ¶å…ƒç´ æœ‰ display: none çš„ input
  const visibleInputs = Array.from(inputs).filter(input => {
    // æ£€æŸ¥ input æœ¬èº«å’Œæ‰€æœ‰çˆ¶å…ƒç´ çš„ display å±æ€§
    let element = input;
    while (element && element !== document.body) {
      const style = window.getComputedStyle(element);
      if (style.display === 'none') {
        return false; // çˆ¶å…ƒç´ æˆ–è‡ªèº«æœ‰ display: noneï¼Œè¿‡æ»¤æ‰
      }
      element = element.parentElement;
    }
    return true; // å¯è§çš„ input
  });
  
  // æ€»æ˜¯æ›´æ–°æ£€æµ‹ç»“æœ
  console.log(`ğŸ” æ£€æµ‹åˆ° ${visibleInputs.length} ä¸ªå¯è§ input å…ƒç´ ï¼ˆæ€»å…± ${inputs.length} ä¸ªï¼‰`);
  
  detectedInputs = visibleInputs.map((input, index) => {
    const info = {
      index: index + 1,
      type: input.type || 'text',
      name: input.name || '',
      id: input.id || '',
      placeholder: input.placeholder || '',
      value: input.value || '',
      className: input.className || '',
      element: input
    };
    
    // åªæ‰“å° radio/checkbox ç±»å‹çš„ input
    if (info.type === 'radio' || info.type === 'checkbox') {
      console.log(`  å¯è§ Input ${index + 1}:`, {
        type: info.type,
        id: info.id,
        name: info.name,
        className: info.className,
        placeholder: info.placeholder
      });
    }
    
    return info;
  });
  
  // æ›´æ–°æ˜¾ç¤ºæ¡†
  updateDisplayBoxContent();
  
  return detectedInputs;
}

// æŸ¥æ‰¾é¡µé¢ä¸­ç¬¦åˆæ¡ä»¶çš„æŒ‰é’®ï¼ˆæœ€åä¸€ä¸ªï¼‰
function findTargetButton() {
  // åªåœ¨ mastery é¡µé¢æ‰æŸ¥æ‰¾æŒ‰é’®
  if (!isPageType('mastery')) {
    return null;
  }
  
  const customContentDivs = document.querySelectorAll('div.custom-content');
  console.log('æ‰¾åˆ° custom-content div æ•°é‡:', customContentDivs.length);
  
  let lastButton = null;
  let buttonCount = 0;
  
  for (let div of customContentDivs) {
    const button = div.querySelector('button');
    if (button) {
      buttonCount++;
      lastButton = button;
      console.log(`æ‰¾åˆ°ç¬¬ ${buttonCount} ä¸ªæŒ‰é’®:`, button);
    }
  }
  
  if (lastButton) {
    console.log(`æ‰¾åˆ°ç›®æ ‡æŒ‰é’®ï¼ˆæœ€åä¸€ä¸ªï¼Œå…± ${buttonCount} ä¸ªï¼‰:`, lastButton);
    targetButton = lastButton;
    return lastButton;
  }
  
  // åªåœ¨ mastery é¡µé¢æ‰è¾“å‡ºæœªæ‰¾åˆ°çš„è­¦å‘Š
  if (customContentDivs.length === 0) {
    // é¡µé¢å¯èƒ½è¿˜åœ¨åŠ è½½ï¼Œä¸è¾“å‡ºè­¦å‘Š
  } else {
    console.log('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æŒ‰é’®');
  }
  return null;
}

// å®šæœŸæŸ¥æ‰¾æŒ‰é’®ï¼ˆå› ä¸ºé¡µé¢å¯èƒ½åŠ¨æ€åŠ è½½ï¼‰
function startButtonMonitor() {
  // åªåœ¨ mastery é¡µé¢æ‰å¯åŠ¨æŒ‰é’®ç›‘æ§
  const isMasteryPage = isPageType('mastery');
  
  if (!isMasteryPage) {
    console.log('é mastery é¡µé¢ï¼Œä¸å¯åŠ¨æŒ‰é’®ç›‘æ§');
    return;
  }
  
  console.log('æ£€æµ‹åˆ° mastery é¡µé¢ï¼Œå¯åŠ¨æŒ‰é’®ç›‘æ§');
  
  // ç«‹å³æŸ¥æ‰¾ä¸€æ¬¡
  findTargetButton();
  
  // å®šæœŸæ£€æŸ¥
  setInterval(() => {
    // å†æ¬¡ç¡®è®¤æ˜¯å¦è¿˜åœ¨ mastery é¡µé¢
    if (isPageType('mastery')) {
      if (!targetButton || !document.body.contains(targetButton)) {
        findTargetButton();
        updateDisplayBox(); // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
      }
    }
  }, 2000);
}

// å¯åŠ¨æŒ‰é’®ç›‘æ§å¹¶åˆå§‹åŒ–æ‚¬æµ®çª—
setTimeout(() => {
  startButtonMonitor();
  initDisplayBox(); // åˆå§‹åŒ–å¹¶æ˜¾ç¤ºæ‚¬æµ®çª—
}, 1000);

function createDisplayBox() {
  if (displayBox) return displayBox;
  
  displayBox = document.createElement('div');
  displayBox.id = 'zhihuishu-secret-display';
  displayBox.style.cssText = `
    position: fixed;
    top: 10px;
    left: 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    z-index: 999999;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    word-break: break-all;
    cursor: move;
  `;
  
  // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
  let isDragging = false;
  let currentX;
  let currentY;
  let initialX;
  let initialY;
  
  displayBox.addEventListener('mousedown', dragStart);
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', dragEnd);
  
  function dragStart(e) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘æ‹–æ‹½
    if (e.target.tagName === 'BUTTON') {
      return;
    }
    initialX = e.clientX - displayBox.offsetLeft;
    initialY = e.clientY - displayBox.offsetTop;
    isDragging = true;
  }
  
  function drag(e) {
    if (isDragging) {
      e.preventDefault();
      currentX = e.clientX - initialX;
      currentY = e.clientY - initialY;
      displayBox.style.left = currentX + 'px';
      displayBox.style.top = currentY + 'px';
    }
  }
  
  function dragEnd() {
    isDragging = false;
  }
  
  document.body.appendChild(displayBox);
  return displayBox;
}

// åˆå§‹åŒ–æ˜¾ç¤ºæ¡†ï¼ˆé¡µé¢åŠ è½½æ—¶å°±æ˜¾ç¤ºï¼‰
function initDisplayBox() {
  const box = createDisplayBox();
  updateDisplayBoxContent();
}

// æ›´æ–°æ˜¾ç¤ºæ¡†çš„å®Œæ•´å†…å®¹
function updateDisplayBoxContent() {
  if (!displayBox) return;
  
  const isStudyPage = isPageType('study');
  const isMasteryPage = isPageType('mastery');
  const hasButton = targetButton && document.body.contains(targetButton);
  const buttonStatus = hasButton ? 
    '<span style="color: #4ade80;">â— å·²æ‰¾åˆ°</span>' : 
    '<span style="color: #fbbf24;">â— æœªæ‰¾åˆ°</span>';
  
  const hasSecretStr = currentSecretStr !== null;
  const isExamPage = isPageType('exam');
  const hasExamFile = currentExamFile !== null;
  
  displayBox.innerHTML = `
    <div style="margin-bottom: 10px; font-weight: bold; font-size: 16px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 8px;">
      ğŸ” æ™ºæ…§æ ‘åŠ©æ‰‹
    </div>
    ${hasExamFile ? `
      <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">
        <div style="margin-bottom: 5px;">
          <strong>ğŸ“š é¢˜åº“:</strong> <span style="color: #4ade80;">${currentExamFile.totalQuestions || 0} é¢˜</span>
        </div>
        <div style="font-size: 11px; color: #e0e0e0; margin-bottom: 5px; word-break: break-all;">
          ${currentExamParams.fileName}
        </div>
        <div style="display: flex; gap: 5px;">
          <button id="download-exam-file" style="
            background: #3b82f6;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            flex: 1;
            transition: all 0.2s;
          " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
            ğŸ“¥ ä¸‹è½½
          </button>
          <button id="clear-exam-file" style="
            background: #ef4444;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            flex: 1;
            transition: all 0.2s;
          " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
            ğŸ—‘ï¸ æ¸…ç©º
          </button>
        </div>
        <button id="clear-all-exams" style="
          background: #991b1b;
          border: none;
          color: white;
          padding: 6px 12px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 10px;
          width: 100%;
          margin-top: 5px;
          transition: all 0.2s;
        " onmouseover="this.style.background='#7f1d1d'" onmouseout="this.style.background='#991b1b'">
          âš ï¸ æ¸…ç©ºæ‰€æœ‰é¢˜åº“
        </button>
      </div>
    ` : ''}
    ${hasSecretStr ? `
      <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">
        <div style="margin-bottom: 8px;">
          <strong>æ—¶é—´:</strong> ${currentTimestamp}
        </div>
        <div style="margin-bottom: 8px;">
          <strong>secretStr:</strong><br/>
          <span style="background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; display: inline-block; margin-top: 5px; font-size: 12px;">
            ${currentSecretStr}
          </span>
        </div>
        ${currentDateFormate ? `
          <div style="margin-bottom: 8px;">
            <strong>dateFormate:</strong> ${currentDateFormate}
          </div>
        ` : ''}
      </div>
    ` : `
      <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2); color: #fbbf24;">
        ç­‰å¾…æˆªè·è¯·æ±‚...
      </div>
    `}
    ${isExamPage ? `
      <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">
        <div style="margin-bottom: 5px;">
          <strong>Input æ£€æµ‹:</strong> <span style="color: #4ade80;">${detectedInputs.length} ä¸ª</span>
        </div>
        ${detectedInputs.length > 0 ? `
          <div style="max-height: 150px; overflow-y: auto; font-size: 11px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px;">
            ${detectedInputs.slice(0, 10).map(input => `
              <div style="margin-bottom: 5px; padding: 3px; border-left: 2px solid #4ade80; padding-left: 5px;">
                <strong>#${input.index}</strong> 
                type: ${input.type}
                ${input.id ? `<br/>id: ${input.id}` : ''}
                ${input.name ? `<br/>name: ${input.name}` : ''}
                ${input.placeholder ? `<br/>placeholder: ${input.placeholder}` : ''}
              </div>
            `).join('')}
            ${detectedInputs.length > 10 ? `<div style="color: #fbbf24; margin-top: 5px;">...è¿˜æœ‰ ${detectedInputs.length - 10} ä¸ª</div>` : ''}
          </div>
        ` : '<div style="font-size: 11px; color: #fbbf24;">æš‚æ—  input å…ƒç´ </div>'}
      </div>
    ` : ''}
    ${isMasteryPage ? `
      <div style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); margin-top: 8px;">
        <button id="start-auto-answer" style="
          background: ${isAutoAnswering ? '#ef4444' : '#10b981'};
          border: none;
          color: white;
          padding: 10px 16px;
          border-radius: 5px;
          cursor: pointer;
          font-weight: bold;
          font-size: 14px;
          width: 100%;
          transition: all 0.2s;
        " onmouseover="this.style.background='${isAutoAnswering ? '#dc2626' : '#059669'}'" 
           onmouseout="this.style.background='${isAutoAnswering ? '#ef4444' : '#10b981'}'">
          ${isAutoAnswering ? 'â¸ï¸ åœæ­¢åˆ·é¢˜' : 'ğŸš€ å¼€å§‹åˆ·é¢˜'}
        </button>
        ${isAutoAnswering ? `
          <div style="margin-top: 8px; font-size: 12px; color: #4ade80;">
            â³ æ­£åœ¨è‡ªåŠ¨ç­”é¢˜...
          </div>
        ` : ''}
      </div>
    ` : ''}
    ${isStudyPage && !isMasteryPage ? `
      <div style="padding-top: 8px;" id="button-control">
        <div style="margin-bottom: 8px;">
          <strong>ç›®æ ‡æŒ‰é’®:</strong> ${buttonStatus}
        </div>
        ${hasButton ? `
          <button id="trigger-button" style="
            background: #10b981;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            width: 100%;
            transition: all 0.2s;
          " onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
            ğŸ¯ ç‚¹å‡»ç›®æ ‡æŒ‰é’®
          </button>
        ` : `
          <div style="color: #fbbf24; font-size: 12px;">
            ç­‰å¾…é¡µé¢åŠ è½½ç›®æ ‡æŒ‰é’®...
          </div>
        `}
      </div>
    ` : ''}
    <div style="margin-top: 10px; font-size: 11px; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;">
      æç¤º: å¯æ‹–åŠ¨æ­¤çª—å£ ${hasSecretStr ? '| åŒå‡»å¤åˆ¶ secretStr' : ''}
    </div>
  `;
  
  // ç»‘å®šè§¦å‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆä»…åœ¨ study é¡µé¢ï¼‰
  if (isStudyPage && hasButton && !isMasteryPage) {
    const triggerBtn = displayBox.querySelector('#trigger-button');
    if (triggerBtn) {
      triggerBtn.addEventListener('click', handleTriggerClick);
    }
  }
  
  // ç»‘å®šå¼€å§‹åˆ·é¢˜æŒ‰é’®ï¼ˆä»…åœ¨ mastery é¡µé¢ï¼‰
  if (isMasteryPage) {
    const autoAnswerBtn = displayBox.querySelector('#start-auto-answer');
    if (autoAnswerBtn) {
      autoAnswerBtn.addEventListener('click', handleAutoAnswer);
    }
  }
  
  // ç»‘å®šä¸‹è½½æŒ‰é’®äº‹ä»¶
  if (hasExamFile) {
    const downloadBtn = displayBox.querySelector('#download-exam-file');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', handleDownloadExamFile);
    }
    
    const clearBtn = displayBox.querySelector('#clear-exam-file');
    if (clearBtn) {
      clearBtn.addEventListener('click', handleClearExamFile);
    }
    
    const clearAllBtn = displayBox.querySelector('#clear-all-exams');
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', handleClearAllExams);
    }
  }
  
  // å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½ï¼ˆä»…å½“æœ‰ secretStr æ—¶ï¼‰
  if (hasSecretStr) {
    displayBox.addEventListener('dblclick', handleDoubleClick);
  }
}

// å¤„ç†åŒå‡»å¤åˆ¶
function handleDoubleClick(e) {
  // å¦‚æœåŒå‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸å¤åˆ¶
  if (e.target.tagName === 'BUTTON') {
    return;
  }
  if (currentSecretStr) {
    navigator.clipboard.writeText(currentSecretStr).then(() => {
      const originalBg = displayBox.style.background;
      displayBox.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
      setTimeout(() => {
        displayBox.style.background = originalBg;
      }, 500);
    });
  }
}

// æ›´æ–°æ˜¾ç¤ºæ¡†å†…å®¹ï¼ˆç”¨äºå®šæœŸæ›´æ–°æŒ‰é’®çŠ¶æ€ï¼‰
function updateDisplayBox() {
  updateDisplayBoxContent();
}

// å¤„ç†è§¦å‘æŒ‰é’®ç‚¹å‡»
function handleTriggerClick(e) {
  e.stopPropagation();
  
  if (targetButton && document.body.contains(targetButton)) {
    console.log('è§¦å‘ç›®æ ‡æŒ‰é’®ç‚¹å‡»');
    
    // æ¨¡æ‹Ÿç‚¹å‡»
    targetButton.click();
    
    // è§†è§‰åé¦ˆ
    const btn = e.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'âœ“ å·²è§¦å‘';
    btn.style.background = '#059669';
    
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.style.background = '#10b981';
    }, 1000);
  } else {
    alert('ç›®æ ‡æŒ‰é’®ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢');
  }
}

// å¤„ç†ä¸‹è½½é¢˜åº“æ–‡ä»¶
function handleDownloadExamFile(e) {
  e.stopPropagation();
  
  if (currentExamParams) {
    try {
      chrome.runtime.sendMessage({
        action: 'downloadExamFile',
        fileName: currentExamParams.fileName
      }, (response) => {
        if (chrome.runtime.lastError) {
          console.error('âŒ Runtime error:', chrome.runtime.lastError.message);
          alert('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
          return;
        }
        
        if (response && response.success) {
          console.log('ä¸‹è½½è¯·æ±‚å·²å‘é€');
          
          // è§†è§‰åé¦ˆ
          const btn = e.target;
          const originalText = btn.innerHTML;
          btn.innerHTML = 'âœ“ ä¸‹è½½ä¸­...';
          btn.style.background = '#2563eb';
          
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = '#3b82f6';
          }, 2000);
        }
      });
    } catch (err) {
      console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥ï¼ˆæ‰©å±•å¯èƒ½å·²é‡æ–°åŠ è½½ï¼‰:', err.message);
      alert('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
    }
  }
}

// å¤„ç†æ¸…ç©ºå½“å‰é¢˜åº“
function handleClearExamFile(e) {
  e.stopPropagation();
  
  if (currentExamParams) {
    const confirmMsg = `ç¡®å®šè¦æ¸…ç©ºå½“å‰é¢˜åº“å—ï¼Ÿ\næ–‡ä»¶: ${currentExamParams.fileName}\né¢˜ç›®æ•°: ${currentExamFile ? currentExamFile.totalQuestions : 0}`;
    
    if (confirm(confirmMsg)) {
      try {
        chrome.runtime.sendMessage({
          action: 'clearExamFile',
          fileName: currentExamParams.fileName
        }, (response) => {
          if (chrome.runtime.lastError) {
            console.error('âŒ Runtime error:', chrome.runtime.lastError.message);
            alert('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
            return;
          }
          
          if (response && response.success) {
            console.log('âœ… é¢˜åº“å·²æ¸…ç©º');
            currentExamFile = response.examFile;
            updateDisplayBoxContent();
            
            // è§†è§‰åé¦ˆ
            const btn = e.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ“ å·²æ¸…ç©º';
            
            setTimeout(() => {
              btn.innerHTML = originalText;
            }, 2000);
          }
        });
      } catch (err) {
        console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥ï¼ˆæ‰©å±•å¯èƒ½å·²é‡æ–°åŠ è½½ï¼‰:', err.message);
        alert('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
      }
    }
  }
}

// å¤„ç†æ¸…ç©ºæ‰€æœ‰é¢˜åº“
function handleClearAllExams(e) {
  e.stopPropagation();
  
  const confirmMsg = 'âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰é¢˜åº“æ•°æ®ï¼Œä¸å¯æ¢å¤ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ';
  
  if (confirm(confirmMsg)) {
    // äºŒæ¬¡ç¡®è®¤
    if (confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰é¢˜åº“å—ï¼Ÿ')) {
      try {
        chrome.runtime.sendMessage({
          action: 'clearAllExams'
        }, (response) => {
          if (chrome.runtime.lastError) {
            console.error('âŒ Runtime error:', chrome.runtime.lastError.message);
            alert('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
            return;
          }
          
          if (response && response.success) {
            console.log('âœ… æ‰€æœ‰é¢˜åº“å·²æ¸…ç©º');
            currentExamFile = null;
            updateDisplayBoxContent();
            
            // è§†è§‰åé¦ˆ
            const btn = e.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ“ å…¨éƒ¨å·²æ¸…ç©º';
            btn.style.background = '#7f1d1d';
            
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.style.background = '#991b1b';
            }, 2000);
            
            alert('æ‰€æœ‰é¢˜åº“å·²æ¸…ç©º');
          }
        });
      } catch (err) {
        console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥ï¼ˆæ‰©å±•å¯èƒ½å·²é‡æ–°åŠ è½½ï¼‰:', err.message);
        alert('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
      }
    }
  }
}

// ==================== è‡ªåŠ¨åˆ·é¢˜åŠŸèƒ½ ====================

// å¤„ç†å¼€å§‹/åœæ­¢è‡ªåŠ¨ç­”é¢˜
function handleAutoAnswer(e) {
  e.stopPropagation();
  
  if (isAutoAnswering) {
    // åœæ­¢è‡ªåŠ¨ç­”é¢˜
    stopAutoAnswering();
  } else {
    // å¼€å§‹è‡ªåŠ¨ç­”é¢˜
    startAutoAnswering();
  }
}

// å¼€å§‹è‡ªåŠ¨ç­”é¢˜
async function startAutoAnswering() {
  console.log('ğŸš€ å¼€å§‹è‡ªåŠ¨åˆ·é¢˜');
  isAutoAnswering = true;
  answerCounter = 1;
  currentExamQuestions = []; // é‡ç½®é¢˜ç›®åˆ—è¡¨
  
  // ä¿å­˜çŠ¶æ€åˆ° storage
  try {
    await chrome.storage.local.set({ isAutoAnswering: true });
    console.log('âœ… è‡ªåŠ¨ç­”é¢˜çŠ¶æ€å·²ä¿å­˜åˆ° storage');
  } catch (e) {
    console.error('âŒ ä¿å­˜çŠ¶æ€å¤±è´¥:', e);
  }
  
  updateDisplayBoxContent();
  
  // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„é¢˜ç›®å¹¶ç‚¹å‡»
  findAndClickNextUncompleted();
}

// åœæ­¢è‡ªåŠ¨ç­”é¢˜
async function stopAutoAnswering() {
  console.log('â¸ï¸ åœæ­¢è‡ªåŠ¨åˆ·é¢˜');
  isAutoAnswering = false;
  answerCounter = 1;
  currentExamQuestions = []; // æ¸…ç©ºé¢˜ç›®åˆ—è¡¨
  
  // æ¸…é™¤çŠ¶æ€
  try {
    await chrome.storage.local.set({ isAutoAnswering: false });
    console.log('âœ… å·²æ¸…é™¤è‡ªåŠ¨ç­”é¢˜çŠ¶æ€');
  } catch (e) {
    console.error('âŒ æ¸…é™¤çŠ¶æ€å¤±è´¥:', e);
  }
  
  if (autoAnswerInterval) {
    clearInterval(autoAnswerInterval);
    autoAnswerInterval = null;
  }
  updateDisplayBoxContent();
}

// æŸ¥æ‰¾å¹¶ç‚¹å‡»ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„é¢˜ç›®
function findAndClickNextUncompleted() {
  // ç¡®ä¿åœ¨ mastery é¡µé¢
  if (!isPageType('mastery')) {
    console.log('âš ï¸ ä¸åœ¨ mastery é¡µé¢ï¼Œæ— æ³•æŸ¥æ‰¾æœªå®Œæˆçš„é¢˜ç›®');
    stopAutoAnswering();
    return false;
  }
  
  const customContentDivs = document.querySelectorAll('div.custom-content');
  console.log('ğŸ” æ‰¾åˆ° custom-content div æ•°é‡:', customContentDivs.length);
  
  for (let i = 0; i < customContentDivs.length; i++) {
    const div = customContentDivs[i];
    
    // æŸ¥æ‰¾ class ä¸º text çš„ div
    const textDiv = div.querySelector('div.text');
    if (textDiv) {
      const span = textDiv.querySelector('span');
      if (span) {
        const text = span.textContent.trim();
        console.log(`ğŸ“Š ç¬¬ ${i + 1} ä¸ªé¢˜ç›®è¿›åº¦:`, text);
        
        // å¦‚æœä¸æ˜¯ 100%ï¼Œç‚¹å‡»å¯¹åº”çš„æŒ‰é’®
        if (text !== '100%') {
          const button = div.querySelector('button');
          if (button) {
            console.log(`âœ… æ‰¾åˆ°æœªå®Œæˆçš„é¢˜ç›® (${i + 1})ï¼Œè¿›åº¦: ${text}ï¼Œå‡†å¤‡ç‚¹å‡»æŒ‰é’®`);
            button.click();
            return true;
          }
        }
      }
    }
  }
  
  console.log('âš ï¸ æ‰€æœ‰é¢˜ç›®éƒ½å·²å®Œæˆ 100%');
  stopAutoAnswering();
  alert('ğŸ‰ æ‰€æœ‰é¢˜ç›®éƒ½å·²å®Œæˆï¼');
  return false;
}

// å¤„ç† pointOfMastery é¡µé¢
function handlePointOfMasteryPage() {
  const currentUrl = window.location.href;
  console.log('ğŸ” å½“å‰é¡µé¢ URL:', currentUrl);
  
  // æ£€æŸ¥æ˜¯å¦åœ¨ pointOfMastery é¡µé¢
  if (!isPageType('pointOfMastery', currentUrl)) {
    console.warn('âš ï¸ ä¸åœ¨ pointOfMastery é¡µé¢ï¼Œç­‰å¾…è·³è½¬...');
    setTimeout(() => {
      if (isAutoAnswering) {
        handlePointOfMasteryPage();
      }
    }, 2000);
    return;
  }
  
  console.log('âœ… å·²è¿›å…¥ pointOfMastery é¡µé¢');
  
  // æŸ¥æ‰¾ class="charts-label-rate" çš„ div
  const chartsLabelRate = document.querySelector('div.charts-label-rate');
  
  if (!chartsLabelRate) {
    console.warn('âš ï¸ æœªæ‰¾åˆ° charts-label-rateï¼Œ2ç§’åé‡è¯•...');
    setTimeout(() => {
      if (isAutoAnswering) {
        handlePointOfMasteryPage();
      }
    }, 2000);
    return;
  }
  
  const rateText = chartsLabelRate.textContent.trim();
  console.log('ğŸ“Š å½“å‰è¿›åº¦:', rateText);
  
  // å¦‚æœè¿›åº¦æ˜¯ 100ï¼Œç‚¹å‡» backup è¿”å› mastery é¡µé¢
  if (rateText === '100') {
    console.log('ğŸ‰ è¿›åº¦å·²è¾¾ 100%ï¼Œç‚¹å‡»è¿”å›æŒ‰é’®');
    const backupDiv = document.querySelector('div.backup');
    
    if (backupDiv) {
      backupDiv.click();
      console.log('âœ… å·²ç‚¹å‡»è¿”å›æŒ‰é’®ï¼Œç­‰å¾…è·³è½¬åˆ° mastery é¡µé¢...');
      
      // ç­‰å¾…è·³è½¬åç»§ç»­å¯»æ‰¾æœªå®Œæˆçš„é¢˜ç›®
      setTimeout(() => {
        if (isAutoAnswering) {
          console.log('ğŸ”„ è¿”å› mastery é¡µé¢ï¼Œç»§ç»­å¯»æ‰¾æœªå®Œæˆé¢˜ç›®...');
          // é‡ç½®è®¡æ•°å™¨
          answerCounter = 1;
          currentExamQuestions = [];
          
          // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
          setTimeout(() => {
            if (isAutoAnswering) {
              findAndClickNextUncompleted();
            }
          }, 2000);
        }
      }, 2000);
    } else {
      console.error('âŒ æœªæ‰¾åˆ° backup æŒ‰é’®');
      stopAutoAnswering();
    }
  } else {
    // è¿›åº¦æœªè¾¾ 100ï¼Œç‚¹å‡» line1-count-link
    console.log('ğŸ“ è¿›åº¦æœªè¾¾ 100%ï¼Œç‚¹å‡»ç»§ç»­ç»ƒä¹ ');
    const line1CountLink = document.querySelector('div.line1-count-link');
    
    if (line1CountLink) {
      line1CountLink.click();
      console.log('âœ… å·²ç‚¹å‡»ç»§ç»­ç»ƒä¹ ï¼Œç­‰å¾…é¡µé¢åŠ è½½...');
      
      // ç­‰å¾…é¡µé¢è·³è½¬åé‡æ–°å¼€å§‹ç­”é¢˜æµç¨‹
      setTimeout(() => {
        if (isAutoAnswering) {
          console.log('ğŸ”„ é¡µé¢å·²åŠ è½½ï¼Œç»§ç»­åˆ·é¢˜...');
          // é‡ç½®è®¡æ•°å™¨
          answerCounter = 1;
          currentExamQuestions = [];
          
          // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
          setTimeout(() => {
            if (isAutoAnswering) {
              // å¦‚æœè·³è½¬åˆ°äº†è€ƒè¯•é¡µé¢ï¼Œç­‰å¾…é¢˜ç›®æ•°æ®
              if (window.location.href.includes('/exam')) {
                console.log('â³ ç­‰å¾…é¢˜ç›®æ•°æ®åŠ è½½...');
                // é¢˜ç›®æ•°æ®ä¼šåœ¨æ‹¦æˆªåˆ°è¯·æ±‚åè‡ªåŠ¨è§¦å‘ç­”é¢˜
              } else if (window.location.href.includes('/study/mastery')) {
                // å¦‚æœå›åˆ°äº† mastery é¡µé¢ï¼Œç»§ç»­å¯»æ‰¾æœªå®Œæˆé¢˜ç›®
                findAndClickNextUncompleted();
              }
            }
          }, 2000);
        }
      }, 2000);
    } else {
      console.error('âŒ æœªæ‰¾åˆ° line1-count-link');
      stopAutoAnswering();
    }
  }
}

// å¤„ç†ç­”é¢˜åˆ†ææ•°æ®ï¼ˆexamAnalysis é¡µé¢ï¼‰
function handleUserAnswersData(data) {
  console.log('ğŸ“Š å¼€å§‹å¤„ç†ç­”é¢˜åˆ†ææ•°æ®');
  
  if (!data || !data.questions) {
    console.error('âŒ ç­”é¢˜åˆ†ææ•°æ®æ ¼å¼é”™è¯¯');
    return;
  }
  
  const questions = data.questions;
  console.log(`ğŸ“ å…±æœ‰ ${questions.length} é“é¢˜ç›®éœ€è¦åˆ†æ`);
  
  // æå–å½“å‰è€ƒè¯•å‚æ•°
  const urlObj = new URL(window.location.href);
  const examId = urlObj.searchParams.get('examId');
  const recruitAndCourseId = urlObj.searchParams.get('recruitAndCourseId');
  const idStr = urlObj.searchParams.get('knowledgeId'); // æ³¨æ„è¿™é‡Œæ˜¯ knowledgeId
  
  if (!idStr || !recruitAndCourseId) {
    console.error('âŒ URL ä¸­ç¼ºå°‘å¿…è¦å‚æ•°');
    return;
  }
  
  const fileName = `idStr=${idStr}&recruitAndCourseId=${recruitAndCourseId}.json`;
  console.log('ğŸ“ å¯¹åº”çš„é¢˜åº“æ–‡ä»¶:', fileName);
  
  let correctCount = 0;
  let wrongCount = 0;
  const updates = [];
  
  // åˆ†ææ¯é“é¢˜ç›®
  questions.forEach(question => {
    const questionId = question.questionId;
    const userAnswerVo = question.userAnswerVo;
    
    if (!userAnswerVo) {
      console.warn(`âš ï¸ é¢˜ç›® ${questionId} æ²¡æœ‰ä½œç­”è®°å½•`);
      return;
    }
    
    const isCorrect = userAnswerVo.isCorrect; // 1=æ­£ç¡®, 2=é”™è¯¯
    
    if (isCorrect === 1) {
      correctCount++;
      console.log(`âœ… é¢˜ç›® ${questionId} ç­”å¯¹äº†ï¼Œç­”æ¡ˆä¸éœ€è¦ä¿®æ”¹`);
    } else if (isCorrect === 2) {
      wrongCount++;
      console.log(`âŒ é¢˜ç›® ${questionId} ç­”é”™äº†ï¼Œéœ€è¦å°†ç­”æ¡ˆ +1`);
      updates.push({
        questionId: questionId,
        action: 'increment'
      });
    }
  });
  
  console.log(`ğŸ“Š ç»Ÿè®¡ç»“æœ: æ­£ç¡® ${correctCount} é¢˜ï¼Œé”™è¯¯ ${wrongCount} é¢˜`);
  
  // å¦‚æœæœ‰éœ€è¦æ›´æ–°çš„é¢˜ç›®ï¼Œå‘é€ç»™ background
  if (updates.length > 0) {
    console.log('ğŸ”„ å‡†å¤‡æ›´æ–°é¢˜åº“...');
    
    try {
      chrome.runtime.sendMessage({
        action: 'updateAnswers',
        fileName: fileName,
        updates: updates
      }, (response) => {
        if (chrome.runtime.lastError) {
          console.error('âŒ Runtime error:', chrome.runtime.lastError.message);
          return;
        }
        
        if (response && response.success) {
          console.log('âœ… é¢˜åº“æ›´æ–°æˆåŠŸ');
          
          // æ›´æ–°å®Œæˆåï¼Œç‚¹å‡»æäº¤æŒ‰é’®è¿›å…¥ä¸‹ä¸€è½®
          if (isAutoAnswering) {
            setTimeout(() => {
              clickSubmitInAnalysisPage();
            }, 1000);
          }
        } else {
          console.error('âŒ é¢˜åº“æ›´æ–°å¤±è´¥');
        }
      });
    } catch (err) {
      console.error('âŒ å‘é€æ›´æ–°æ¶ˆæ¯å¤±è´¥:', err.message);
    }
  } else {
    console.log('âœ… æ‰€æœ‰é¢˜ç›®éƒ½ç­”å¯¹äº†ï¼Œä¸éœ€è¦æ›´æ–°é¢˜åº“');
    
    // ç›´æ¥ç‚¹å‡»æäº¤æŒ‰é’®
    if (isAutoAnswering) {
      setTimeout(() => {
        clickSubmitInAnalysisPage();
      }, 1000);
    }
  }
}

// åœ¨ç­”é¢˜åˆ†æé¡µé¢ç‚¹å‡»æäº¤æŒ‰é’®
function clickSubmitInAnalysisPage() {
  console.log('ğŸ” æŸ¥æ‰¾ç­”é¢˜åˆ†æé¡µé¢çš„æäº¤æŒ‰é’®...');
  console.log('ğŸ“ å½“å‰é¡µé¢ URL:', window.location.href);
  
  // å°è¯•å¤šç§é€‰æ‹©å™¨
  const selectors = [
    'div.submit',
    '.submit',
    'div[class*="submit"]',
    'button.submit',
    'div.confirm',
    '.confirm',
    'div.next',
    '.next'
  ];
  
  let submitElement = null;
  
  for (const selector of selectors) {
    submitElement = document.querySelector(selector);
    if (submitElement) {
      console.log(`âœ… æ‰¾åˆ°æäº¤å…ƒç´  (${selector}):`, submitElement);
      break;
    }
  }
  
  if (submitElement) {
    console.log('ğŸ¯ å‡†å¤‡ç‚¹å‡»æäº¤æŒ‰é’®');
    console.log('æŒ‰é’®æ–‡æœ¬:', submitElement.textContent);
    console.log('æŒ‰é’®ç±»å:', submitElement.className);
    
    // å°è¯•å¤šç§ç‚¹å‡»æ–¹å¼
    try {
      // æ–¹å¼1: ç›´æ¥ç‚¹å‡»
      submitElement.click();
      console.log('âœ… å·²æ‰§è¡Œ click()');
      
      // æ–¹å¼2: è§¦å‘é¼ æ ‡äº‹ä»¶
      const clickEvent = new MouseEvent('click', {
        bubbles: true,
        cancelable: true,
        view: window
      });
      submitElement.dispatchEvent(clickEvent);
      console.log('âœ… å·²è§¦å‘ MouseEvent');
      
      // æ–¹å¼3: å¦‚æœæ˜¯ divï¼Œå°è¯•æŸ¥æ‰¾å†…éƒ¨çš„ button
      const innerButton = submitElement.querySelector('button');
      if (innerButton) {
        console.log('ğŸ” æ‰¾åˆ°å†…éƒ¨ buttonï¼Œç‚¹å‡»');
        innerButton.click();
      }
      
    } catch (e) {
      console.error('âŒ ç‚¹å‡»å¤±è´¥:', e);
    }
    
    // ç‚¹å‡»åä¼šè·³è½¬å›è€ƒè¯•é¡µé¢ï¼Œç­‰å¾…é¡µé¢åŠ è½½
    setTimeout(() => {
      if (isAutoAnswering) {
        console.log('â³ [clickSubmitInAnalysisPage] ç­‰å¾…è·³è½¬å›è€ƒè¯•é¡µé¢...');
        console.log('ğŸ“Š [clickSubmitInAnalysisPage] å½“å‰ URL:', window.location.href);
        console.log('ğŸ“Š [clickSubmitInAnalysisPage] currentExamQuestions:', currentExamQuestions.length);
        
        // é‡ç½®è®¡æ•°å™¨
        answerCounter = 1;
        console.log('ğŸ”„ [clickSubmitInAnalysisPage] å·²é‡ç½®è®¡æ•°å™¨');
        
        // æ³¨æ„: ä¸æ¸…ç©º currentExamQuestionsï¼Œå› ä¸ºæ˜¯åŒä¸€å¥—é¢˜ç›®
        console.log('ğŸ“Š [clickSubmitInAnalysisPage] ä¿ç•™é¢˜ç›®æ•°æ®ï¼Œé¢˜ç›®æ•°é‡:', currentExamQuestions.length);
        
        // ç­‰å¾…é¢˜ç›®æ•°æ®åŠ è½½åè‡ªåŠ¨å¼€å§‹ç­”é¢˜
        setTimeout(() => {
          const currentUrl = window.location.href;
          console.log('ğŸ“ å½“å‰ URL:', currentUrl);
          
          if (currentUrl.includes('/exam') && isAutoAnswering) {
            console.log('âœ… å·²å›åˆ°è€ƒè¯•é¡µé¢');
            console.log('ğŸ“Š å½“å‰é¢˜ç›®æ•°æ®çŠ¶æ€:', currentExamQuestions.length, 'é¢˜');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é¢˜ç›®æ•°æ®
            if (currentExamQuestions.length > 0) {
              console.log('ğŸš€ é¢˜ç›®æ•°æ®å·²å­˜åœ¨ï¼Œç«‹å³å¼€å§‹ç­”é¢˜');
              autoAnswerInExamPage();
            } else {
              console.log('â³ é¢˜ç›®æ•°æ®ä¸ºç©ºï¼Œç­‰å¾…é¡µé¢å‘é€è¯·æ±‚...');
              console.log('ğŸ’¡ é¡µé¢åº”è¯¥ä¼šè‡ªåŠ¨å‘é€ exam/start è¯·æ±‚');
              
              // ä¸»åŠ¨ç­‰å¾…ä¸€æ®µæ—¶é—´è®©é¡µé¢æœ‰æœºä¼šå‘é€è¯·æ±‚
              setTimeout(() => {
                if (currentExamQuestions.length > 0) {
                  console.log('âœ… å·²æ‹¦æˆªåˆ°é¢˜ç›®æ•°æ®ï¼Œå¼€å§‹ç­”é¢˜');
                  autoAnswerInExamPage();
                } else {
                  console.warn('âš ï¸ 3ç§’åä»æœªæ‹¦æˆªåˆ°æ•°æ®ï¼Œè°ƒç”¨ autoAnswerInExamPage è¿›å…¥ç­‰å¾…æµç¨‹');
                  autoAnswerInExamPage(); // è¿›å…¥ç­‰å¾…å¾ªç¯
                }
              }, 3000);
            }
          } else {
            console.log('âš ï¸ æœªå›åˆ°è€ƒè¯•é¡µé¢æˆ–è‡ªåŠ¨ç­”é¢˜å·²åœæ­¢');
          }
        }, 2000);
      }
    }, 1000);
  } else {
    console.error('âŒ æœªæ‰¾åˆ°æäº¤æŒ‰é’® (å°è¯•äº†å¤šä¸ªé€‰æ‹©å™¨)');
    
    // å°è¯•æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„æŒ‰é’®
    console.log('ğŸ” å°è¯•æŸ¥æ‰¾æ‰€æœ‰ div å’Œ button...');
    
    const allDivs = document.querySelectorAll('div');
    console.log(`ğŸ“Š æ€»å…±æ‰¾åˆ° ${allDivs.length} ä¸ª div`);
    
    // æŸ¥æ‰¾åŒ…å«"æäº¤"ã€"ç¡®å®š"ã€"ç»§ç»­"ç­‰å…³é”®å­—çš„ div
    for (const div of allDivs) {
      const text = div.textContent.trim();
      const className = div.className;
      
      if (text === 'æäº¤' || text === 'ç¡®å®š' || text === 'ç»§ç»­' || text === 'ä¸‹ä¸€æ­¥') {
        console.log('âœ… æ‰¾åˆ°å¯èƒ½çš„æäº¤æŒ‰é’® (é€šè¿‡æ–‡æœ¬):', text, 'class:', className);
        div.click();
        
        // è§¦å‘å¤šç§äº‹ä»¶
        div.dispatchEvent(new MouseEvent('click', { bubbles: true }));
        div.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
        div.dispatchEvent(new MouseEvent('mouseup', { bubbles: true }));
        
        return;
      }
      
      // æ£€æŸ¥ class åç§°
      if (className && (className.includes('submit') || className.includes('confirm') || className.includes('next'))) {
        console.log('âœ… æ‰¾åˆ°å¯èƒ½çš„æäº¤æŒ‰é’® (é€šè¿‡ class):', className, 'text:', text.substring(0, 50));
        div.click();
        div.dispatchEvent(new MouseEvent('click', { bubbles: true }));
        return;
      }
    }
    
    // æŸ¥æ‰¾æ‰€æœ‰ button
    const buttons = document.querySelectorAll('button');
    console.log(`ğŸ” æ‰¾åˆ° ${buttons.length} ä¸ª button`);
    
    for (const btn of buttons) {
      const text = btn.textContent.trim();
      console.log('æŒ‰é’®æ–‡æœ¬:', text, 'class:', btn.className);
      
      if (text.includes('æäº¤') || text.includes('ç¡®å®š') || text.includes('ç»§ç»­') || text.includes('ä¸‹ä¸€æ­¥')) {
        console.log('âœ… æ‰¾åˆ°ç–‘ä¼¼æäº¤æŒ‰é’®:', text);
        btn.click();
        btn.dispatchEvent(new MouseEvent('click', { bubbles: true }));
        return;
      }
    }
    
    console.error('âŒ æœªæ‰¾åˆ°ä»»ä½•æäº¤æŒ‰é’®ï¼Œåœæ­¢è‡ªåŠ¨ç­”é¢˜');
    console.log('ğŸ’¡ æç¤º: è¯·æ‰‹åŠ¨ç‚¹å‡»æäº¤æŒ‰é’®ï¼Œç„¶åé‡æ–°å¼€å§‹åˆ·é¢˜');
    // ä¸åœæ­¢è‡ªåŠ¨ç­”é¢˜ï¼Œç­‰å¾…æ‰‹åŠ¨ç‚¹å‡»
    // stopAutoAnswering();
  }
}

// åœ¨è€ƒè¯•é¡µé¢è‡ªåŠ¨ç­”é¢˜
function autoAnswerInExamPage() {
  if (!isAutoAnswering) {
    console.log('â¸ï¸ è‡ªåŠ¨ç­”é¢˜å·²åœæ­¢');
    return;
  }
  
  console.log(`ğŸ“ å¼€å§‹ç­”é¢˜æµç¨‹ï¼Œå½“å‰è®¡æ•°å™¨: ${answerCounter}`);
  console.log(`ğŸ“Š å½“å‰é¢˜ç›®æ•°æ®: ${currentExamQuestions.length} é¢˜`);
  
  // æ£€æŸ¥æ˜¯å¦æœ‰é¢˜ç›®æ•°æ®
  if (currentExamQuestions.length === 0) {
    console.warn('âš ï¸ æ²¡æœ‰é¢˜ç›®æ•°æ®ï¼Œç­‰å¾…é¢˜ç›®åŠ è½½...');
    console.log('ğŸ’¡ æç¤º: é¡µé¢å¯èƒ½å·²åˆ·æ–°ï¼Œç­‰å¾…æ‹¦æˆªæ–°çš„è€ƒè¯•æ•°æ®è¯·æ±‚');
    
    // æ£€æŸ¥æ‹¦æˆªå™¨çŠ¶æ€
    if (window.__INTERCEPTOR_READY__) {
      console.log('âœ… æ‹¦æˆªå™¨å·²å°±ç»ª');
    } else {
      console.warn('âš ï¸ æ‹¦æˆªå™¨å¯èƒ½æœªå°±ç»ªï¼Œæ£€æŸ¥ page-interceptor.js æ˜¯å¦å·²åŠ è½½');
    }
    
    let waitCount = 0;
    const maxWait = 5;
    
    const waitForData = () => {
      waitCount++;
      console.log(`â³ ç­‰å¾…é¢˜ç›®æ•°æ®... (${waitCount}/${maxWait})`);
      console.log(`ğŸ“Š currentExamQuestions.length: ${currentExamQuestions.length}`);
      console.log(`ğŸ” æ‹¦æˆªå™¨çŠ¶æ€: ${window.__INTERCEPTOR_READY__ ? 'å°±ç»ª' : 'æœªå°±ç»ª'}`);
      
      if (currentExamQuestions.length > 0) {
        console.log('âœ… é¢˜ç›®æ•°æ®å·²åŠ è½½ï¼Œç»§ç»­ç­”é¢˜');
        autoAnswerInExamPage();
      } else if (waitCount < maxWait && isAutoAnswering) {
        setTimeout(waitForData, 2000);
      } else {
        console.error('âŒ ç­‰å¾…è¶…æ—¶ï¼Œé¢˜ç›®æ•°æ®æœªåŠ è½½');
        console.error('ğŸ’¡ å¯èƒ½åŸå› ï¼š');
        console.error('   1. é¡µé¢æœªå‘é€ exam/start è¯·æ±‚');
        console.error('   2. è¯·æ±‚å·²å‘é€ä½†æ‹¦æˆªå™¨æœªæ•è·');
        console.error('   3. å“åº”æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ');
        console.error('è¯·æ£€æŸ¥ Network é¢æ¿ä¸­æ˜¯å¦æœ‰ exam/start è¯·æ±‚');
      }
    };
    
    setTimeout(waitForData, 2000);
    return;
  }
  
  // å¼€å§‹ç­”é¢˜æµç¨‹ï¼šç‚¹å‡»ç¬¬ä¸€ä¸ª item
  console.log('ï¿½ å¼€å§‹ç­”é¢˜æµç¨‹');
  clickNextQuestion();
}

// è·å–å½“å‰é¢˜ç›®IDï¼ˆå·²åºŸå¼ƒï¼Œæ”¹ç”¨ currentExamQuestionsï¼‰
function getCurrentQuestionId() {
  // ä¸å†éœ€è¦è¿™ä¸ªå‡½æ•°ï¼Œç›´æ¥ä» currentExamQuestions è·å–
  return null;
}

// ä»é¢˜åº“è·å–ç­”æ¡ˆ
function getAnswerFromExamFile(questionId) {
  if (!currentExamFile || !currentExamFile.questions) {
    return null;
  }
  
  const question = currentExamFile.questions[questionId];
  return question ? question.answer : null;
}

// åªå¡«å…¥ç­”æ¡ˆï¼Œä¸å¤„ç†åç»­é€»è¾‘
function fillAnswerOnly(answerIndex) {
  // è·å–æ‰€æœ‰å¯è§çš„ input (radio æˆ– checkbox ç±»å‹)
  const visibleInputs = detectedInputs.filter(input => {
    const isValidType = input.type === 'radio' || input.type === 'checkbox';
    const isVisible = input.element && document.body.contains(input.element);
    return isValidType && isVisible;
  });
  
  console.log(`ğŸ“‹ å¯è§çš„ radio/checkbox input æ•°é‡: ${visibleInputs.length}`);
  console.log(`ğŸ’¡ éœ€è¦å¡«å…¥ç¬¬ ${answerIndex} ä¸ª input`);
  
  // ç‚¹å‡»ç¬¬ answerIndex ä¸ª input (ç´¢å¼•ä»1å¼€å§‹)
  const targetInput = visibleInputs[answerIndex - 1];
  if (targetInput && targetInput.element) {
    console.log(`âœ… ç‚¹å‡»ç¬¬ ${answerIndex} ä¸ª input (ç±»å‹: ${targetInput.type})`);
    targetInput.element.click();
    
    // ä¹Ÿå°è¯•è§¦å‘ change äº‹ä»¶
    const changeEvent = new Event('change', { bubbles: true });
    targetInput.element.dispatchEvent(changeEvent);
    
    // å¯¹äº checkboxï¼Œå¯èƒ½éœ€è¦è§¦å‘ input äº‹ä»¶
    if (targetInput.type === 'checkbox') {
      const inputEvent = new Event('input', { bubbles: true });
      targetInput.element.dispatchEvent(inputEvent);
    }
    
    // ç­‰å¾…1ç§’åï¼Œè®¡æ•°å™¨åŠ ä¸€å¹¶ç‚¹å‡»ä¸‹ä¸€é¢˜
    setTimeout(() => {
      answerCounter++;
      console.log(`ğŸ“Š è®¡æ•°å™¨æ›´æ–°ä¸º: ${answerCounter}`);
      clickNextQuestion();
    }, 1000);
  } else {
    console.error(`âŒ ç¬¬ ${answerIndex} ä¸ª input ä¸å­˜åœ¨ï¼Œå¯ç”¨ input æ•°é‡: ${visibleInputs.length}`);
    // ç­‰å¾…1ç§’åç»§ç»­
    setTimeout(() => {
      answerCounter++;
      clickNextQuestion();
    }, 1000);
  }
}

// ç‚¹å‡»ä¸‹ä¸€é¢˜æˆ–æäº¤
function clickNextQuestion() {
  // æ¯æ¬¡éƒ½é‡æ–°æ£€æµ‹é¡µé¢ä¸­ class ä¸º item çš„ div
  const itemDivs = document.querySelectorAll('div.item');
  console.log(`ğŸ” é‡æ–°æ£€æµ‹åˆ° ${itemDivs.length} ä¸ª class ä¸º item çš„ div`);
  console.log(`ğŸ“Š å½“å‰è®¡æ•°å™¨å€¼: ${answerCounter}`);
  
  // å¦‚æœè®¡æ•°å™¨å€¼å¤§äº item çš„ä¸ªæ•°ï¼Œç‚¹å‡»æäº¤æŒ‰é’®
  if (answerCounter > itemDivs.length) {
    console.log(`âœ… è®¡æ•°å™¨ ${answerCounter} > item æ•°é‡ ${itemDivs.length}ï¼Œå‡†å¤‡ç‚¹å‡»æäº¤æŒ‰é’®`);
    const submitDiv = document.querySelector('div.submit');
    if (submitDiv) {
      console.log('ğŸ¯ æ‰¾åˆ°æäº¤æŒ‰é’®ï¼Œç‚¹å‡»æäº¤');
      submitDiv.click();
      
      // æäº¤åç­‰å¾…é¡µé¢è·³è½¬ï¼Œç„¶åå¤„ç† pointOfMastery é¡µé¢
      console.log('â³ ç­‰å¾…é¡µé¢è·³è½¬åˆ° pointOfMastery...');
      setTimeout(() => {
        handlePointOfMasteryPage();
      }, 3000);
    } else {
      console.error('âŒ æ²¡æœ‰æ‰¾åˆ°æäº¤æŒ‰é’® (div.submit)');
      isAutoAnswering = false;
    }
    return;
  }
  
  // ç‚¹å‡»å¯¹åº”è®¡æ•°å™¨å€¼çš„ item (è®¡æ•°å™¨ä»1å¼€å§‹ï¼Œç´¢å¼•ä»0å¼€å§‹)
  const targetItem = itemDivs[answerCounter - 1];
  if (targetItem) {
    console.log(`ğŸ¯ ç‚¹å‡»ç¬¬ ${answerCounter} ä¸ª item`);
    targetItem.click();
    
    // ç‚¹å‡»åç­‰å¾…é¡µé¢æ›´æ–°ï¼Œç„¶åæ£€æµ‹ input å¹¶å¡«ç­”æ¡ˆ
    setTimeout(() => {
      if (isAutoAnswering) {
        detectAndFillAnswer();
      }
    }, 1500);
  } else {
    console.error(`âŒ ç¬¬ ${answerCounter} ä¸ª item ä¸å­˜åœ¨ï¼Œæ€»å…± ${itemDivs.length} ä¸ª item`);
  }
}

// æ£€æµ‹ input å¹¶å¡«å…¥ç­”æ¡ˆ
function detectAndFillAnswer() {
  console.log('ğŸ” å¼€å§‹æ£€æµ‹ input å…ƒç´ ...');
  
  // é‡æ–°æ£€æµ‹ input å…ƒç´ 
  detectInputElements();
  
  // ç¨ç­‰ä¸€ä¸‹å†æ£€æŸ¥ï¼Œç¡®ä¿ detectedInputs å·²æ›´æ–°
  setTimeout(() => {
    // è·å–æ‰€æœ‰å¯è§çš„ radio/checkbox input
    const availableInputs = detectedInputs.filter(input => {
      const isValidType = input.type === 'radio' || input.type === 'checkbox';
      const isVisible = input.element && document.body.contains(input.element);
      return isValidType && isVisible;
    });
    
    console.log(`ğŸ“Š æ£€æµ‹åˆ° ${availableInputs.length} ä¸ªå¯ç”¨çš„ radio/checkbox input`);
    
    if (availableInputs.length === 0) {
      console.warn('âš ï¸ æœªæ£€æµ‹åˆ°å¯ç”¨çš„ input å…ƒç´ ï¼Œ2ç§’åé‡è¯•...');
      
      // 2ç§’åé‡è¯•
      setTimeout(() => {
        if (!isAutoAnswering) return;
        
        console.log('ğŸ”„ é‡æ–°æ£€æµ‹ input...');
        detectInputElements();
        
        // å†æ¬¡ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ£€æµ‹å®Œæˆ
        setTimeout(() => {
          const retryInputs = detectedInputs.filter(input => {
            const isValidType = input.type === 'radio' || input.type === 'checkbox';
            const isVisible = input.element && document.body.contains(input.element);
            return isValidType && isVisible;
          });
          
          console.log(`ğŸ“Š é‡è¯•åæ£€æµ‹åˆ° ${retryInputs.length} ä¸ªå¯ç”¨çš„ radio/checkbox input`);
          
          if (retryInputs.length > 0) {
            console.log('âœ… é‡æ–°æ£€æµ‹åˆ° inputï¼Œç»§ç»­å¡«ç­”æ¡ˆ');
            fillAnswerForCurrentQuestion();
          } else {
            console.error('âŒ é‡è¯•åä»æœªæ‰¾åˆ° input å…ƒç´ ï¼Œè·³è¿‡æ­¤é¢˜');
            // ç­‰å¾…1ç§’åï¼Œè®¡æ•°å™¨åŠ ä¸€å¹¶ç»§ç»­ä¸‹ä¸€é¢˜
            setTimeout(() => {
              answerCounter++;
              clickNextQuestion();
            }, 1000);
          }
        }, 100);
      }, 2000);
      
      return;
    }
    
    // æ£€æµ‹åˆ° inputï¼Œå¡«å…¥ç­”æ¡ˆ
    console.log('âœ… æ£€æµ‹åˆ°å¯ç”¨ inputï¼Œå‡†å¤‡å¡«ç­”æ¡ˆ');
    fillAnswerForCurrentQuestion();
  }, 100);
}

// ä¸ºå½“å‰é¢˜ç›®å¡«å…¥ç­”æ¡ˆ
function fillAnswerForCurrentQuestion() {
  // è·å–å½“å‰é¢˜ç›®
  const currentQuestion = currentExamQuestions[answerCounter - 1];
  if (!currentQuestion) {
    console.error(`âŒ æ²¡æœ‰æ‰¾åˆ°ç¬¬ ${answerCounter} é¢˜çš„æ•°æ®`);
    // è·³è¿‡æ­¤é¢˜
    setTimeout(() => {
      answerCounter++;
      clickNextQuestion();
    }, 1000);
    return;
  }
  
  const currentQuestionId = currentQuestion.questionId;
  console.log(`ğŸ“‹ å½“å‰é¢˜ç›® ${answerCounter}/${currentExamQuestions.length}, ID: ${currentQuestionId}`);
  
  // ä»é¢˜åº“è·å–ç­”æ¡ˆ
  const answer = getAnswerFromExamFile(currentQuestionId);
  if (!answer) {
    console.warn(`âš ï¸ é¢˜åº“ä¸­æ²¡æœ‰é¢˜ç›® ${currentQuestionId} çš„ç­”æ¡ˆï¼Œä½¿ç”¨é»˜è®¤ç­”æ¡ˆ 1`);
  }
  
  const answerIndex = answer || 1;
  console.log(`ğŸ’¡ é¢˜ç›® ${currentQuestionId} çš„ç­”æ¡ˆç´¢å¼•: ${answerIndex}`);
  
  // å¡«å…¥ç­”æ¡ˆï¼ˆä¸å†åœ¨ fillAnswer å†…éƒ¨å¤„ç†åç»­é€»è¾‘ï¼‰
  fillAnswerOnly(answerIndex);
}

// ç‚¹å‡»ä¸‹ä¸€é¢˜æˆ–æäº¤ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ clickNextQuestion æ›¿ä»£ï¼‰
// è¯¥å‡½æ•°å·²è¢«æ–°é€»è¾‘æ›¿æ¢ï¼Œä¿ç•™ä»¥é˜²å¼•ç”¨

function showSecretStr(secretStr, dateFormate, fullUrl) {
  // ä¿å­˜æ•°æ®
  currentSecretStr = secretStr;
  currentDateFormate = dateFormate;
  currentTimestamp = new Date().toLocaleTimeString('zh-CN');
  
  console.log('æ˜¾ç¤º secretStr:', secretStr);
  console.log('å®Œæ•´URL:', fullUrl);
  
  // å¦‚æœæ‚¬æµ®çª—è¿˜ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
  if (!displayBox) {
    createDisplayBox();
  }
  
  // æ›´æ–°æ˜¾ç¤ºå†…å®¹
  updateDisplayBoxContent();
}

// ç›‘å¬æ¥è‡ª background çš„æ¶ˆæ¯
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log('Message received in content script:', request);
  
  if (request.action === 'showSecretStr') {
    showSecretStr(request.secretStr, request.dateFormate, request.fullUrl);
    sendResponse({ success: true });
  }
  
  if (request.action === 'examDataProcessed') {
    // è€ƒè¯•æ•°æ®å·²å¤„ç†å®Œæˆ
    console.log('è€ƒè¯•æ•°æ®å·²æ›´æ–°:', request.result);
    currentExamFile = request.result.examFile;
    updateDisplayBoxContent();
  }
  
  if (request.action === 'testAction') {
    console.log('Test action triggered:', request.data);
    
    // åœ¨é¡µé¢ä¸Šæ‰§è¡Œä¸€äº›æ“ä½œ
    document.body.style.border = '5px solid red';
    setTimeout(() => {
      document.body.style.border = '';
    }, 2000);
    
    sendResponse({ success: true, message: 'Action completed' });
  }
  
  return true;
});
